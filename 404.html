<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404 - Policy & Contact Generator</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <h1 class="nav-title">Policy & Contact Generator</h1>
                <div class="nav-links">
                    <a href="/">Trang chủ</a>
                    <a href="/open/privacy-policy/example">Privacy Policy</a>
                    <a href="/open/contact-us/example">Contact Us</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Đang kiểm tra và tải nội dung...</p>
        </div>

        <div id="error" class="error hidden">
            <h2>Lỗi</h2>
            <p id="error-message"></p>
            <button onclick="window.location.href='/'" class="btn">Về trang chủ</button>
        </div>

        <div id="content" class="page hidden">
            <div class="content-header">
                <button onclick="window.location.href='/'" class="btn btn-secondary">← Về trang chủ</button>
                <div class="breadcrumb">
                    <span id="breadcrumb-text"></span>
                </div>
            </div>
            <article id="markdown-content" class="markdown-content">
                <!-- Nội dung markdown sẽ được render ở đây -->
            </article>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2024 Policy & Contact Generator. Made with ❤️</p>
    </footer>

    <script>
class NotFoundHandler {
    constructor() {
        this.pathPrefix = this.calculatePathPrefix();
        this.init();
    }

    calculatePathPrefix() {
        const path = window.location.pathname;
        const depth = (path.match(/\//g) || []).length - 1;
        return depth > 0 ? '../'.repeat(depth) : '';
    }

    async init() {
        // Fix CSS path for GitHub Pages
        if (this.pathPrefix) {
            const cssLink = document.querySelector('link[href="/css/style.css"]');
            if (cssLink) {
                cssLink.href = this.pathPrefix + 'css/style.css';
            }
        }

        // Analyze current path
        await this.analyzePath();
    }

    async analyzePath() {
        const path = window.location.pathname;
        console.log('Analyzing path:', path);

        try {
            if (this.isValidPath(path)) {
                console.log('Valid path detected, loading content...');
                await this.loadValidPath(path);
            } else {
                console.log('Invalid path detected, loading 404 page...');
                await this.load404Page();
            }
        } catch (error) {
            console.error('Error in analyzePath:', error);
            this.showError(`Lỗi khi xử lý: ${error.message}`);
        }
    }

    isValidPath(path) {
        // Kiểm tra format /open/{type}/{name}
        const pathParts = path.split('/').filter(part => part !== '');
        
        if (pathParts.length !== 3 || pathParts[0] !== 'open') {
            return false;
        }

        const [, type, name] = pathParts;

        // Kiểm tra type hợp lệ
        if (!['privacy-policy', 'contact-us'].includes(type)) {
            return false;
        }

        // Kiểm tra name không rỗng và hợp lệ
        if (!name || name.trim() === '' || !/^[a-zA-Z0-9\-_]+$/.test(name)) {
            return false;
        }

        return true;
    }

    async loadValidPath(path) {
        const pathParts = path.split('/').filter(part => part !== '');
        const [, type, name] = pathParts;

        try {
            const filePath = `${this.pathPrefix}data/${type}/${name}.md`;
            console.log('Attempting to load:', filePath);

            const response = await fetch(filePath);
            
            if (!response.ok) {
                console.log('File not found, loading 404...');
                await this.load404Page();
                return;
            }

            const markdownText = await response.text();
            const htmlContent = marked.parse(markdownText);
            
            this.showContent(htmlContent, name, type);
            
        } catch (error) {
            console.error('Error loading valid path:', error);
            await this.load404Page();
        }
    }

    async load404Page() {
        try {
            const filePath = `${this.pathPrefix}data/404.md`;
            console.log('Loading 404 page from:', filePath);

            const response = await fetch(filePath);
            
            if (!response.ok) {
                // Nếu không có file 404.md, tạo nội dung mặc định
                const defaultContent = `# 404 - Trang Không Tìm Thấy

Xin lỗi, trang bạn đang tìm kiếm không tồn tại.

[Về trang chủ](/)`;
                const htmlContent = marked.parse(defaultContent);
                this.showContent(htmlContent, '404', 'error', true);
                return;
            }

            const markdownText = await response.text();
            const htmlContent = marked.parse(markdownText);
            
            this.showContent(htmlContent, '404', 'error', true);
            
        } catch (error) {
            console.error('Error loading 404 page:', error);
            const defaultContent = `# 404 - Trang Không Tìm Thấy

Xin lỗi, trang bạn đang tìm kiếm không tồn tại.

[Về trang chủ](/)`;
            const htmlContent = marked.parse(defaultContent);
            this.showContent(htmlContent, '404', 'error', true);
        }
    }

    showContent(htmlContent, name, type, is404 = false) {
        const contentDiv = document.getElementById('content');
        const markdownContentDiv = document.getElementById('markdown-content');
        const breadcrumbDiv = document.getElementById('breadcrumb-text');
        const loadingDiv = document.getElementById('loading');

        // Ẩn loading
        loadingDiv.classList.add('hidden');

        // Cập nhật breadcrumb
        let breadcrumbText = '';
        if (is404) {
            breadcrumbText = '404 - Trang không tìm thấy';
        } else {
            const typeDisplay = type === 'privacy-policy' ? 'Privacy Policy' : 'Contact Us';
            breadcrumbText = `${typeDisplay} / ${name}`;
        }
        breadcrumbDiv.textContent = breadcrumbText;

        // Cập nhật nội dung
        markdownContentDiv.innerHTML = htmlContent;

        // Cập nhật title
        if (is404) {
            document.title = '404 - Trang không tìm thấy';
        } else {
            const typeDisplay = type === 'privacy-policy' ? 'Privacy Policy' : 'Contact Us';
            document.title = `${typeDisplay} - ${name}`;
        }

        // Hiển thị trang
        contentDiv.classList.remove('hidden');

        // Scroll to top
        window.scrollTo(0, 0);
    }

    showError(message) {
        const errorDiv = document.getElementById('error');
        const errorMessageDiv = document.getElementById('error-message');
        const loadingDiv = document.getElementById('loading');

        // Ẩn loading
        loadingDiv.classList.add('hidden');

        errorMessageDiv.textContent = message;
        errorDiv.classList.remove('hidden');

        document.title = 'Lỗi - Policy & Contact Generator';
    }
}

// Khởi tạo khi DOM ready
document.addEventListener('DOMContentLoaded', () => {
    new NotFoundHandler();
});
</script>
</body>
</html>
