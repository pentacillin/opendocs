<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404 - Policy & Contact Generator</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <h1 class="nav-title">Policy & Contact Generator</h1>
                <div class="nav-links">
                    <a href="/">Trang ch·ªß</a>
                    <a href="/open/privacy-policy/example">Privacy Policy</a>
                    <a href="/open/contact-us/example">Contact Us</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>ƒêang ki·ªÉm tra v√† t·∫£i n·ªôi dung...</p>
        </div>

        <div id="error" class="error hidden">
            <h2>L·ªói</h2>
            <p id="error-message"></p>
            <button onclick="window.location.href='/'" class="btn">V·ªÅ trang ch·ªß</button>
        </div>

        <div id="content" class="page hidden">
            <div class="content-header">
                <button onclick="window.location.href='/'" class="btn btn-secondary">‚Üê V·ªÅ trang ch·ªß</button>
                <div class="breadcrumb">
                    <span id="breadcrumb-text"></span>
                </div>
            </div>
            <article id="markdown-content" class="markdown-content">
                <!-- N·ªôi dung markdown s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
            </article>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2024 Policy & Contact Generator. Made with ‚ù§Ô∏è</p>
    </footer>

    <script>
        class NotFoundHandler {
            constructor() {
                this.pathPrefix = this.calculatePathPrefix();
                this.init();
            }

            calculatePathPrefix() {
                const path = window.location.pathname;
                const depth = (path.match(/\//g) || []).length - 1;
                return depth > 0 ? '../'.repeat(depth) : '';
            }

            async init() {
                // Fix CSS path for GitHub Pages
                if (this.pathPrefix) {
                    const cssLink = document.querySelector('link[href="/css/style.css"]');
                    if (cssLink) {
                        cssLink.href = this.pathPrefix + 'css/style.css';
                    }
                }

                // Analyze current path
                await this.analyzePath();
            }

            async analyzePath() {
                const path = window.location.pathname;
                console.log('Analyzing path:', path);

                try {
                    if (this.isValidPath(path)) {
                        console.log('Valid path detected, loading content...');
                        await this.loadValidPath(path);
                    } else {
                        console.log('Invalid path detected, loading 404 page...');
                        await this.load404Page();
                    }
                } catch (error) {
                    console.error('Error in analyzePath:', error);
                    this.showError(`L·ªói khi x·ª≠ l√Ω: ${error.message}`);
                }
            }

            isValidPath(path) {
                // Ki·ªÉm tra format /open/{type}/{name}
                const pathParts = path.split('/').filter(part => part !== '');
                
                if (pathParts.length !== 3 || pathParts[0] !== 'open') {
                    return false;
                }

                const [, type, name] = pathParts;

                // Ki·ªÉm tra type h·ª£p l·ªá
                if (!['privacy-policy', 'contact-us'].includes(type)) {
                    return false;
                }

                // Ki·ªÉm tra name kh√¥ng r·ªóng v√† h·ª£p l·ªá
                if (!name || name.trim() === '' || !/^[a-zA-Z0-9\-_]+$/.test(name)) {
                    return false;
                }

                return true;
            }

            async loadValidPath(path) {
                const pathParts = path.split('/').filter(part => part !== '');
                const [, type, name] = pathParts;

                try {
                    const filePath = `${this.pathPrefix}data/${type}/${name}.md`;
                    console.log('Attempting to load:', filePath);

                    const response = await fetch(filePath);
                    
                    if (!response.ok) {
                        console.log('File not found, generating dynamic 404...');
                        await this.loadDynamic404(name, type);
                        return;
                    }

                    const markdownText = await response.text();
                    const htmlContent = marked.parse(markdownText);
                    
                    this.showContent(htmlContent, name, type);
                    
                } catch (error) {
                    console.error('Error loading valid path:', error);
                    await this.loadDynamic404(name, type);
                }
            }

            async load404Page() {
                try {
                    const filePath = `${this.pathPrefix}data/page/404.md`;
                    console.log('Loading 404 page from:', filePath);

                    const response = await fetch(filePath);
                    
                    if (!response.ok) {
                        // N·∫øu kh√¥ng c√≥ file 404.md, t·∫°o n·ªôi dung m·∫∑c ƒë·ªãnh
                        const defaultContent = this.getDefault404Content();
                        const htmlContent = marked.parse(defaultContent);
                        this.showContent(htmlContent, '404', 'page', true);
                        return;
                    }

                    const markdownText = await response.text();
                    const htmlContent = marked.parse(markdownText);
                    
                    this.showContent(htmlContent, '404', 'page', true);
                    
                } catch (error) {
                    console.error('Error loading 404 page:', error);
                    const defaultContent = this.getDefault404Content();
                    const htmlContent = marked.parse(defaultContent);
                    this.showContent(htmlContent, '404', 'page', true);
                }
            }

            async loadDynamic404(name, type) {
                const content404 = this.generateDynamic404Content(name, type);
                const htmlContent = marked.parse(content404);
                this.showContent(htmlContent, name, type, true);
            }

            generateDynamic404Content(name, type) {
                const typeDisplay = type === 'privacy-policy' ? 'Privacy Policy' : 'Contact Us';
                const currentPath = window.location.pathname;

                return `# 404 - File Kh√¥ng T·ªìn T·∫°i

## ${typeDisplay} cho "${name}" kh√¥ng t√¨m th·∫•y

ƒê∆∞·ªùng d·∫´n **${currentPath}** h·ª£p l·ªá nh∆∞ng file t∆∞∆°ng ·ª©ng kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng.

### üìÅ Th√¥ng tin file:
- **Lo·∫°i**: ${typeDisplay}
- **T√™n**: ${name}
- **ƒê∆∞·ªùng d·∫´n file**: \`data/${type}/${name}.md\`
- **URL hi·ªán t·∫°i**: \`${currentPath}\`

### üîç C√≥ th·ªÉ b·∫°n ƒëang t√¨m:

- [Privacy Policy m·∫´u](/open/privacy-policy/example)
- [Contact Us m·∫´u](/open/contact-us/example)
- [V·ªÅ trang ch·ªß](/)

### üìù H∆∞·ªõng d·∫´n t·∫°o file:

1. **T·∫°o th∆∞ m·ª•c** (n·∫øu ch∆∞a c√≥):
   \`\`\`
   mkdir -p data/${type}
   \`\`\`

2. **T·∫°o file markdown**:
   \`\`\`
   touch data/${type}/${name}.md
   \`\`\`

3. **Th√™m n·ªôi dung m·∫´u**:
   \`\`\`markdown
   # ${typeDisplay} - ${name}

   ## Gi·ªõi thi·ªáu
   N·ªôi dung ${typeDisplay.toLowerCase()} c·ªßa ${name}...

   ## Th√¥ng tin li√™n h·ªá
   - Email: contact@${name.toLowerCase().replace(/[^a-z0-9]/g, '')}.com
   - Website: https://${name.toLowerCase().replace(/[^a-z0-9]/g, '')}.com
   \`\`\`

### ‚ö° T·ª± ƒë·ªông t·∫°o file:

B·∫°n c√≥ th·ªÉ copy n·ªôi dung sau v√†o file \`data/${type}/${name}.md\`:

\`\`\`markdown
# ${typeDisplay} - ${name}

*C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${new Date().toLocaleDateString('vi-VN')}*

## Th√¥ng tin chung

ƒê√¢y l√† trang ${typeDisplay.toLowerCase()} c·ªßa **${name}**.

## Li√™n h·ªá

- **Email**: info@${name.toLowerCase().replace(/[^a-z0-9]/g, '')}.com
- **ƒêi·ªán tho·∫°i**: +84 123 456 789
- **Website**: https://${name.toLowerCase().replace(/[^a-z0-9]/g, '')}.com

---
*File n√†y ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông. Vui l√≤ng c·∫≠p nh·∫≠t n·ªôi dung ph√π h·ª£p.*
\`\`\`

---

**üí° M·∫πo**: Sau khi t·∫°o file, refresh trang n√†y ƒë·ªÉ xem n·ªôi dung m·ªõi.`;
            }

            getDefault404Content() {
                const currentPath = window.location.pathname;
                
                return `# 404 - Trang Kh√¥ng T√¨m Th·∫•y

## Oops! C√≥ g√¨ ƒë√≥ kh√¥ng ƒë√∫ng...

ƒê∆∞·ªùng d·∫´n **${currentPath}** kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng t·ªìn t·∫°i.

### üö´ L√Ω do c√≥ th·ªÉ:

1. **URL kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng**
   - ƒê·ªãnh d·∫°ng ƒë√∫ng: \`/open/{type}/{name}\`
   - V√≠ d·ª•: \`/open/privacy-policy/company-a\`

2. **Type kh√¥ng h·ª£p l·ªá**
   - Ch·ªâ h·ªó tr·ª£: \`privacy-policy\` v√† \`contact-us\`

3. **T√™n file kh√¥ng h·ª£p l·ªá**
   - Ch·ªâ ch·∫•p nh·∫≠n: ch·ªØ c√°i, s·ªë, d·∫•u g·∫°ch ngang (-) v√† g·∫°ch d∆∞·ªõi (_)

### üîç Th·ª≠ c√°c li√™n k·∫øt sau:

- [üè† Trang ch·ªß](/)
- [üìã Privacy Policy m·∫´u](/open/privacy-policy/example)
- [üìû Contact Us m·∫´u](/open/contact-us/example)

### üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:

#### URL h·ª£p l·ªá:
- \`/open/privacy-policy/company-a\` ‚úÖ
- \`/open/contact-us/my-business\` ‚úÖ
- \`/open/privacy-policy/example\` ‚úÖ

#### URL kh√¥ng h·ª£p l·ªá:
- \`/open/invalid-type/company\` ‚ùå
- \`/open/privacy-policy/\` ‚ùå
- \`/open/privacy-policy/company with spaces\` ‚ùå

### üõ†Ô∏è C·∫ßn h·ªó tr·ª£?

N·∫øu b·∫°n cho r·∫±ng ƒë√¢y l√† l·ªói h·ªá th·ªëng, vui l√≤ng:
1. Ki·ªÉm tra l·∫°i URL
2. ƒê·∫£m b·∫£o file markdown t·ªìn t·∫°i
3. Li√™n h·ªá qu·∫£n tr·ªã vi√™n n·∫øu v·∫•n ƒë·ªÅ v·∫´n ti·∫øp t·ª•c

---

**Th√¥ng tin k·ªπ thu·∫≠t:**
- Path: \`${currentPath}\`
- Timestamp: ${new Date().toLocaleString('vi-VN')}
- User Agent: \`${navigator.userAgent.substring(0, 50)}...\``;
            }

            showContent(htmlContent, name, type, is404 = false) {
                const contentDiv = document.getElementById('content');
                const markdownContentDiv = document.getElementById('markdown-content');
                const breadcrumbDiv = document.getElementById('breadcrumb-text');
                const loadingDiv = document.getElementById('loading');

                // ·∫®n loading
                loadingDiv.classList.add('hidden');

                // C·∫≠p nh·∫≠t breadcrumb
                let breadcrumbText = '';
                if (type === 'page') {
                    breadcrumbText = '404 - Trang kh√¥ng t√¨m th·∫•y';
                } else {
                    const typeDisplay = type === 'privacy-policy' ? 'Privacy Policy' : 'Contact Us';
                    const status = is404 ? ' (File kh√¥ng t·ªìn t·∫°i)' : '';
                    breadcrumbText = `${typeDisplay} / ${name}${status}`;
                }
                breadcrumbDiv.textContent = breadcrumbText;

                // C·∫≠p nh·∫≠t n·ªôi dung
                markdownContentDiv.innerHTML = htmlContent;

                // C·∫≠p nh·∫≠t title
                if (type === 'page') {
                    document.title = '404 - Trang kh√¥ng t√¨m th·∫•y';
                } else {
                    const typeDisplay = type === 'privacy-policy' ? 'Privacy Policy' : 'Contact Us';
                    const titlePrefix = is404 ? '404 - ' : '';
                    document.title = `${titlePrefix}${typeDisplay} - ${name}`;
                }

                // Hi·ªÉn th·ªã trang
                contentDiv.classList.remove('hidden');

                // Fix relative links
                this.fixRelativeLinks(markdownContentDiv);

                // Scroll to top
                window.scrollTo(0, 0);
            }

            fixRelativeLinks(container) {
                const links = container.querySelectorAll('a[href^="/"]');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href.startsWith('/open/')) {
                        // Internal link - s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi browser
                        return;
                    }
                    // C√°c link kh√°c gi·ªØ nguy√™n
                });
            }

            showError(message) {
                const errorDiv = document.getElementById('error');
                const errorMessageDiv = document.getElementById('error-message');
                const loadingDiv = document.getElementById('loading');

                // ·∫®n loading
                loadingDiv.classList.add('hidden');

                errorMessageDiv.textContent = message;
                errorDiv.classList.remove('hidden');

                document.title = 'L·ªói - Policy & Contact Generator';
            }
        }

        // Kh·ªüi t·∫°o khi DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            new NotFoundHandler();
        });
    </script>
</body>
</html>
